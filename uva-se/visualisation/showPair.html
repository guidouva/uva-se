<!DOCTYPE html>
<meta charset="utf-8">
<style>
.browser {
  background-color: #555555;
  height: 400px;
  width: 650px;
  overflow: scroll;
  white-space: nowrap;
 }

.browserItem {
  fill: #555555;
  color: white;
  font: 10pt "Courier New";
  text-anchor: end;
}

.comparison {
  height: 400px;
  width: 700px;
  white-space: nowrap;
  display: inline-block;

  background-color: #333333;
  color: white;
  overflow: scroll;
  font: 10pt "Courier New";
  text-anchor: end;  
}
</style>

<div class="browser" id="browser"></div>
<div class="comparison" id="comparisonLeft"></div> 
<div class="comparison" id="comparisonRight"></div> 

<script src="//d3js.org/d3.v3.min.js"></script>
<script>
var comparisonLeft = d3.select("#comparisonLeft");
var comparisonRight = d3.select("#comparisonRight");

var browserfield = d3.select(".browser");

d3.json("smallsql.json", function(error, data) {
  showPair([data.clonedata[0][0], data.clonedata[0][1]], data.files);
  showPair([data.clonedata[1][0], data.clonedata[1][1]], data.files);

  showFileBrowsers(data.clonedata[0][0].file, [data.clonedata[0][1].file], data.files, data.clonedata);

  createCloneClasses(data.clonedata);
});

function createCloneClasses(clonedata) {
  var cloneConnections = {};

  for (var i = 0; i < clonedata.length; i++) {
    var left = clonedata[i][0];
    var right = clonedata[i][1];
    if (!(left.text in cloneConnections)) {
      cloneConnections[left.text] = [left];
    }

    cloneConnections[left.text].push(right);
  }
  var cloneClasses = {};


  // TODO json stringify (JSON.stringify())
  var keys = Object.keys(cloneConnections);
  for (var i = 0; i < keys.length; i++) {
    cloneConnections[keys[i]].sort(function(a,b) {
      if (a.text < b.text) return -1;
      if (a.text > b.text) return 1;
      return 0;
    });
    var key = "";
    for (var j = 0; j < cloneConnections[keys[i]].length; j++) {
      key += cloneConnections[keys[i]][j].text;
    }

    cloneClasses[key] = cloneConnections[keys[i]];
  }
  
  var classes = [];

  for (var key in cloneClasses) {
    classes.push(cloneClasses[key]);
  }

  console.log(classes);

  return classes;
}

function showFileBrowsers(fileId, otherFileIds, files, clonedata) {
  pairs = [];

  for (var i = 0; i < clonedata.length; i++) {
    if (clonedata[i][0].file == fileId && otherFileIds.indexOf(clonedata[i][1].file) != -1) {
      pairs.push(clonedata[i]);
    }
  }
  
  var barHeight = 20;
  var divisionHeight = 5;
  
  browserHeight = pairs.length * (barHeight + divisionHeight); 
  browserfield.attr("height", browserHeight)

  var browserfieldUpdate = browserfield.selectAll("div").data(pairs);

  browserfieldUpdate.enter().append("div")
      .attr("x", 0)
      .attr("y", function(d, i) {return (i * barHeight + i * divisionHeight);})
      .attr("width", "100%")
      .attr("height", barHeight)
      .attr("class", "browserItem")
      .on("click", function(d) {showPair(d, files);});
  
  browserfieldUpdate
      .html(function(d, i) {
        return i + " " + files[d[0].file] + " " + files[d[1].file];
      });
}

function showPair(pair, files) {
    showClone(comparisonLeft, pair[0], files);
    showClone(comparisonRight, pair[1], files);
}

function showClone(field, clone, files) {
  field.data([clone])
    .html(function(d) {
        var text = d.text;
        text = addLineNumbers(text, d.begin);
        text = files[d.file] + "\n\n" + text

        text = text.replace(/\n/g, "<br>").replace(/\t/g, "&nbsp;&nbsp;&nbsp;&nbsp;");
        return text;
      });
}

function addLineNumbers(text, beginLineNumber) {
  var lines = text.split("\n");

  for (var i = 0; i < lines.length; i++) {
    lines[i] = (beginLineNumber + i) + ") " + lines[i];
  }

  return lines.join("\n");
}


</script>