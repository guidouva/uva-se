<!DOCTYPE html>
<meta charset="utf-8">
<style>
.browser {
  background-color: #555555;
  height: 400px;
  width: 650px;
  overflow: scroll;
  white-space: nowrap;
 }

.browserItem {
  fill: #555555;
  color: white;
  font: 10pt "Courier New";
  text-anchor: end;
}

.comparison {
  height: 400px;
  width: 700px;
  white-space: nowrap;
  display: inline-block;

  background-color: #333333;
  color: white;
  overflow: scroll;
  font: 10pt "Courier New";
  text-anchor: end;  
}
</style>

<div class="browser" id="browser"></div>
<div class="comparison" id="comparisonLeft"></div> 
<div class="comparison" id="comparisonRight"></div> 

<script src="//d3js.org/d3.v3.min.js"></script>
<script>
var comparisonLeft = d3.select("#comparisonLeft");
var comparisonRight = d3.select("#comparisonRight");

var browserfield = d3.select(".browser");

d3.json("smallsql.json", function(error, data) {
  showPair([data.clonedata[0][0], data.clonedata[0][1]], data.files);
  showPair([data.clonedata[1][0], data.clonedata[1][1]], data.files);

  showFileBrowsers(data.clonedata[0][0].file, [data.clonedata[0][1].file], data.files, data.clonedata);

  createCloneClasses(data.clonedata);

  console.log(removeIndentation(removeComments("    hello! // comment")));
});

function createCloneClasses(clonedata) {
  var cloneConnections = {};

  for (var i = 0; i < clonedata.length; i++) {
    var left = clonedata[i][0];
    var right = clonedata[i][1];
    if (!(left.text in cloneConnections)) {
      cloneConnections[left.text] = [left];
    }

    cloneConnections[left.text].push(right);
  }
  var cloneClasses = {};


  // TODO json stringify (JSON.stringify())
  var keys = Object.keys(cloneConnections);
  for (var i = 0; i < keys.length; i++) {
    cloneConnections[keys[i]].sort(function(a,b) {
      if (a.text < b.text) return -1;
      if (a.text > b.text) return 1;
      return 0;
    });
    var key = "";
    for (var j = 0; j < cloneConnections[keys[i]].length; j++) {
      key += cloneConnections[keys[i]][j].text;
    }

    cloneClasses[key] = cloneConnections[keys[i]];
  }
  
  var classes = [];

  for (var key in cloneClasses) {
    classes.push(cloneClasses[key]);
  }

  console.log(classes);

  return classes;
}

function showFileBrowsers(fileId, otherFileIds, files, clonedata) {
  pairs = [];

  for (var i = 0; i < clonedata.length; i++) {
    if (clonedata[i][0].file == fileId && otherFileIds.indexOf(clonedata[i][1].file) != -1) {
      pairs.push(clonedata[i]);
    }
  }
  
  var barHeight = 20;
  var divisionHeight = 5;
  
  browserHeight = pairs.length * (barHeight + divisionHeight); 
  browserfield.attr("height", browserHeight)

  var browserfieldUpdate = browserfield.selectAll("div").data(pairs);

  browserfieldUpdate.enter().append("div")
      .attr("x", 0)
      .attr("y", function(d, i) {return (i * barHeight + i * divisionHeight);})
      .attr("width", "100%")
      .attr("height", barHeight)
      .attr("class", "browserItem")
      .on("click", function(d) {showPair(d, files);});
  
  browserfieldUpdate
      .html(function(d, i) {
        var type = 2;

        var text1 = removeComments(d[0].text);
        var text2 = removeComments(d[1].text);

        if (text1 == text2) {
          type = 1;
          console.log(text1);
          console.log(text2);  
        }

        return i + " Type: " + type + " " + files[d[0].file] + " " + files[d[1].file];
      });
}

function showPair(pair, files) {
    showClone(comparisonLeft, pair[0], files);
    showClone(comparisonRight, pair[1], files);
}

function showClone(field, clone, files) {
  field.data([clone])
    .html(function(d) {
        var text = d.text;
        text = addLineNumbers(text, d.begin);
        text = files[d.file] + "\n\n" + text

        text = text.replace(/\n/g, "<br>").replace(/\t/g, "&nbsp;&nbsp;&nbsp;&nbsp;");
        return text;
      });
}

function addLineNumbers(text, beginLineNumber) {
  var lines = text.split("\n");

  for (var i = 0; i < lines.length; i++) {
    lines[i] = (beginLineNumber + i) + ") " + lines[i];
  }

  return lines.join("\n");
}

function removeIndentation(str) {
  var lines = str.split("\n");

  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];
    
    for (var j = 0; j < line.length; j++) {
      if (line[j] == ' ') {
        line = line.replace(" ", "");
        j--;
      }
      else if (line[j] == '\t') {
        line = line.replace("\t", "");
        j--; 
      }
    }

    lines[i] = line;
  }

  return lines.join("\n");
}

/* 
    This function is loosely based on the one found here:
    http://www.weanswer.it/blog/optimize-css-javascript-remove-comments-php/
*/
function removeComments(str) {
    str = ('__' + str + '__').split('');
    var mode = {
        singleQuote: false,
        doubleQuote: false,
        regex: false,
        blockComment: false,
        lineComment: false,
        condComp: false 
    };
    for (var i = 0, l = str.length; i < l; i++) {
 
        if (mode.regex) {
            if (str[i] === '/' && str[i-1] !== '\\') {
                mode.regex = false;
            }
            continue;
        }
 
        if (mode.singleQuote) {
            if (str[i] === "'" && str[i-1] !== '\\') {
                mode.singleQuote = false;
            }
            continue;
        }
 
        if (mode.doubleQuote) {
            if (str[i] === '"' && str[i-1] !== '\\') {
                mode.doubleQuote = false;
            }
            continue;
        }
 
        if (mode.blockComment) {
            if (str[i] === '*' && str[i+1] === '/') {
                str[i+1] = '';
                mode.blockComment = false;
            }
            str[i] = '';
            continue;
        }
 
        if (mode.lineComment) {
            if (str[i] == '\\' && (str[i+1] === 'n' || str[i+1] === 'r')) {
                mode.lineComment = false;
            }
            str[i] = '';
            continue;
        }
 
        if (mode.condComp) {
            if (str[i-2] === '@' && str[i-1] === '*' && str[i] === '/') {
                mode.condComp = false;
            }
            continue;
        }
 
        mode.doubleQuote = str[i] === '"';
        mode.singleQuote = str[i] === "'";
 
        if (str[i] === '/') {
 
            if (str[i+1] === '*' && str[i+2] === '@') {
                mode.condComp = true;
                continue;
            }
            if (str[i+1] === '*') {
                str[i] = '';
                mode.blockComment = true;
                continue;
            }
            if (str[i+1] === '/') {
                str[i] = '';
                mode.lineComment = true;
                continue;
            }
            mode.regex = true;
 
        }
 
    }
    return str.join('').slice(2, -2);
}

</script>